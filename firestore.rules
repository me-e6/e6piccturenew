rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    // POSTS (PUBLIC READ, OWNER WRITE, SCHEMA-LOCKED)
    // =====================================================
    match /posts/{postId} {

      // -----------------------
      // PUBLIC READ
      // -----------------------
      allow read: if true;

      // -----------------------
      // CREATE (STRICT)
      // -----------------------
      allow create: if request.auth != null
        // ownership
        && request.auth.uid == request.resource.data.authorId

        // immutable identity
        && request.resource.data.postId == postId

        // required schema
        && request.resource.data.keys().hasAll([
          'postId',
          'authorId',
          'authorName',
          'isVerifiedOwner',
          'imageUrls',
          'isRepost',
          'likeCount',
          'replyCount',
          'quoteReplyCount',
          'createdAt'
        ])

        // type validation
        && request.resource.data.postId is string
        && request.resource.data.authorId is string
        && request.resource.data.authorName is string
        && request.resource.data.isVerifiedOwner is bool
        && request.resource.data.isRepost is bool
        && request.resource.data.imageUrls is list
        && request.resource.data.imageUrls.size() > 0
        && request.resource.data.likeCount == 0
        && request.resource.data.replyCount == 0
        && request.resource.data.quoteReplyCount == 0
        && request.resource.data.createdAt is timestamp;

      // -----------------------
      // UPDATE (SAFE MUTATION)
      // -----------------------
      allow update: if request.auth != null
        // only author
        && request.auth.uid == resource.data.authorId

        // freeze identity fields forever
        && request.resource.data.authorId == resource.data.authorId
        && request.resource.data.postId == resource.data.postId
        && request.resource.data.authorName == resource.data.authorName
        && request.resource.data.isVerifiedOwner == resource.data.isVerifiedOwner
        && request.resource.data.createdAt == resource.data.createdAt

        // allow only these fields to change
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly([
            'likeCount',
            'replyCount',
            'quoteReplyCount'
          ])

        // counters must remain sane
        && request.resource.data.likeCount >= 0
        && request.resource.data.replyCount >= 0
        && request.resource.data.quoteReplyCount >= 0;

      // -----------------------
      // DELETE (DISABLED)
      // -----------------------
      allow delete: if false;
    }
  }
}
