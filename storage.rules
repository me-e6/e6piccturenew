rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // -----------------------
    // PROFILE PHOTOS
    // Path: /profile/{uid}/avatar.jpg
    // -----------------------
    match /profile/{userId}/{fileName} {

      // Anyone can read profile photos
      allow read: if true;

      // Only owner can upload/update
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && isValidImage()
                   && isSmallEnough();
    }

    // -----------------------
    // POST IMAGES
    // Path: /posts/{uid}/{filename}
    // -----------------------
    match /posts/{userId}/{fileName} {

      // Public read for feeds
      allow read: if true;

      // Only owner can upload
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && isValidImage()
                   && isSmallEnough();
    }

    // -----------------------
    // DEFAULT DENY
    // -----------------------
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

// -----------------------
//  HELPERS
// -----------------------
function isValidImage() {
  return request.resource.contentType.matches('image/.*');
}

function isSmallEnough() {
  // 10 MB max
  return request.resource.size < 10 * 1024 * 1024;
}
